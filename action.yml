name: Plugin Build
description: Build the plugin and create a zip file.

inputs:
  PACKAGE_VERSION:
    required: false
    description: 'Optional. The version of the package to use.'
    default: ""

outputs:
  artifact_name:
    description: "The name of the generated zip file."
    value: ${{ steps.build_plugin.outputs.PLUGIN_FILENAME }}

runs:
  using: "composite"
  steps:
    - name: Install Dependencies
      shell: bash
      run: |
        npm ci
        composer install --optimize-autoloader --prefer-dist
        composer install --no-scripts --no-dev
        composer dump-autoload

    - name: Set GitHub Repository Name Environment Variable
      shell: bash
      run: |
        REPOSITORY_NAME=$(echo "${{ github.repository }}" | awk -F/ '{print $NF}')

        echo "REPOSITORY_NAME=${REPOSITORY_NAME}" >> $GITHUB_ENV

    - name: Set Package Version Environment Variable
      shell: bash
      run: |
        if [ -z "${{ inputs.PACKAGE_VERSION }}" ]; then

          DATE_VERSION=$(date '+%Y%m%d.%H%M')
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          BUILD_PACKAGE_VERSION=${PACKAGE_VERSION}-${DATE_VERSION}

          if [ "${{ env.REPOSITORY_NAME }}" == "elementor-pro" ]; then
            ELEMENTOR_VERSION_DEPENDENCY=$(node -p "require('./package.json').elementor_version_dependency")
            ELEMENTOR_VERSION_RECOMMENDATION=$(node -p "require('./package.json').elementor_version_recommendation")

            echo "ELEMENTOR_VERSION_DEPENDENCY=${ELEMENTOR_VERSION_DEPENDENCY}" >> $GITHUB_ENV
            echo "ELEMENTOR_VERSION_RECOMMENDATION=${ELEMENTOR_VERSION_RECOMMENDATION}" >> $GITHUB_ENV

          fi

        else

          PACKAGE_VERSION=${{ inputs.PACKAGE_VERSION }}
          BUILD_PACKAGE_VERSION=${PACKAGE_VERSION}

        fi

        echo "BUILD_PACKAGE_VERSION=${BUILD_PACKAGE_VERSION}" >> $GITHUB_ENV

    - name:  Update Versions in elementor files
      shell: bash
      run: |
        if [ -z "${{ inputs.PACKAGE_VERSION }}" ]; then

          sed -i -E "s/Version: (.*?)/Version: ${{ env.BUILD_PACKAGE_VERSION }}/g" ./${{ env.REPOSITORY_NAME }}.php

          if [ "${{ env.REPOSITORY_NAME }}" == "elementor" ]; then

            sed -i -E "s/ELEMENTOR_VERSION', '(.*?)'/ELEMENTOR_VERSION', '${{ env.BUILD_PACKAGE_VERSION }}'/g" ./${{ env.REPOSITORY_NAME }}.php

          elif [ "${{ env.REPOSITORY_NAME }}" == "elementor-pro" ]; then

            sed -i -E "s/ELEMENTOR_PRO_VERSION', '(.*?)'/ELEMENTOR_PRO_VERSION', '${{ env.BUILD_PACKAGE_VERSION }}'/g" ./${{ env.REPOSITORY_NAME }}.php
            sed -i -E "s/ELEMENTOR_PRO_REQUIRED_CORE_VERSION', '(.*?)'/ELEMENTOR_PRO_REQUIRED_CORE_VERSION', '${{ env.ELEMENTOR_VERSION_DEPENDENCY }}'/g" ./${{ env.REPOSITORY_NAME }}.php
            sed -i -E "s/ELEMENTOR_PRO_RECOMMENDED_CORE_VERSION', '(.*?)'/ELEMENTOR_PRO_RECOMMENDED_CORE_VERSION', '${{ env.ELEMENTOR_VERSION_RECOMMENDATION }}'/g" ./${{ env.REPOSITORY_NAME }}.php

          fi

        fi
    - name: Build Core Plugin
      if: env.REPOSITORY_NAME == 'elementor'
      id: build_plugin
      shell: bash
      run: |
        npm config set git-tag-version false
        export PUPPETEER_SKIP_DOWNLOAD=true

        npx grunt build

        PLUGIN_FILENAME=elementor-${{ env.BUILD_PACKAGE_VERSION }}
        PLUGIN_ZIP_FILENAME=${PLUGIN_FILENAME}.zip

        mv build elementor

        zip -r ${PLUGIN_ZIP_FILENAME} elementor

        echo "PLUGIN_FILENAME=${PLUGIN_FILENAME}" >> $GITHUB_OUTPUT

    - name: Build Pro Plugin
      if: env.REPOSITORY_NAME == 'elementor-pro'
      id: build_plugin
      shell: bash
      run: |
        npm config set git-tag-version false
        export PUPPETEER_SKIP_DOWNLOAD=true
        ELEMENTOR_CORE_BRANCH="${ELEMENTOR_CORE_BRANCH:=main}"

        rm -rf ../elementor
        echo "Cloning ELEMENTOR_CORE_BRANCH: ${ELEMENTOR_CORE_BRANCH}"

        git clone --single-branch --branch ${ELEMENTOR_CORE_BRANCH} https://github.com/elementor/elementor.git ../elementor
        PLUGIN_FILENAME="elementor-pro-${PACKAGE_VERSION}"
        PLUGIN_ZIP_FILENAME="${PLUGIN_FILENAME}.zip"
        npx grunt build
        PACKAGE_BASE_DIR="/tmp/elementor-pro-releases/"
        PACKAGE_PATH=$(ls $PACKAGE_BASE_DIR)
        mv "${PACKAGE_BASE_DIR}/${PACKAGE_PATH}" ${PLUGIN_ZIP_FILENAME}
        PLUGIN_ZIP_PATH=$(pwd)/${PLUGIN_ZIP_FILENAME}
        echo ${PACKAGE_PATH}
        echo "PLUGIN_ZIP_FILENAME=${PLUGIN_ZIP_FILENAME}" >> $GITHUB_ENV
        echo "PLUGIN_ZIP_PATH=${PLUGIN_ZIP_PATH}" >> $GITHUB_ENV

        unzip -q ${PLUGIN_ZIP_PATH} -d /tmp/
        cd /tmp/
        rm ${PLUGIN_ZIP_PATH}
        zip -r -q ${PLUGIN_ZIP_PATH} ./elementor-pro

        echo "PLUGIN_FILENAME=${PLUGIN_FILENAME}" >> $GITHUB_OUTPUT

    - name: Publish zip on push to release or develop
      shell: bash
      if: env.REPOSITORY_NAME == 'elementor-pro' && github.event_name == 'push' && startsWith(github.repository, 'elementor/') && (startsWith(github.ref, 'refs/heads/release/') || github.ref == 'refs/heads/develop')
      run: curl --fail -F "package=@${{ env.PLUGIN_ZIP_FILENAME }}" "${{ secrets.DEPLOY_BUILDS_ENDPOINT }}&type=pro"

    - name: Upload Build Zip Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.build_plugin.outputs.PLUGIN_FILENAME }}
        path: ${{ env.REPOSITORY_NAME }}
        retention-days: 1
